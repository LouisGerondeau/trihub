{% extends "core/base.html" %}
{% block content %}
  <h1>Séances pour {{ coach }}</h1>
  <style>
/* Carte séance */
.session-card {
  border: 1px solid #ccc; border-radius: 8px;
  padding: 12px 14px; margin: 10px 0;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.session-missing { border-color: #d9534f; background-color: #f8d7da; }
.session-enough { border-color: #48a065ff; background-color: #d9f8ccff; }
.session-header { font-weight: 600; margin: 0 0 8px 0; font-size: 1rem; line-height: 1.3; }

/* Coach chips */
.coach-chip{
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 10px; border:1px solid #ccc; border-radius:14px;
  margin:4px 6px 0 0; font-size:0.95rem;
}
.coach-chip a.remove{ text-decoration:none; font-weight:700; font-size:1.1rem; line-height:1; }


/* Touch targets plus grands sur petits écrans */
@media (max-width: 480px){
  .session-card{ padding:14px; }
  .session-header{ font-size:1.05rem; }
  .coach-chip{ padding:8px 12px; font-size:1rem; }
  .coach-chip a.remove{ font-size:1.25rem; }
}
  </style>
  {% include "core/filter_public_sessions.html" %}
  {% for yw, sessions in weeks %}
    {% with year=yw.0 week=yw.1 %}
      <h2>Semaine {{ week }} ({{ year }})</h2>
      {% for sl in sessions %}
        {% with s=sl.0 is_assigned=sl.1 %}
          <div class="session-card {% if s.confirmed_cnt < s.min_coaches %}session-missing{% else %}session-enough{% endif %}">
            <div class="session-header">{{ s.title_auto }}</div>
            <div>
              Encadrants :
              {% for a in s.assignments.all %}
                {% if a.status == "confirmed" %}<span class="coach-chip">{{ a.coach }}</span>{% endif %}
              {% empty %}Aucun
              {% endfor %}
              {% comment %} {% with coach_ids=s.assignments.all.values_list("coach_id", flat=True) %} {% endcomment %}
              {% if is_assigned %}
                <a class="btn btn-warning"
                   href="{% url 'unassign_confirm' %}?session_id={{ s.id }}&coach_id={{ coach.id }}&origin={{ request.get_full_path|urlencode }}">
                  Me retirer
                </a>
              {% else %}
                <a class="btn btn-success"
                   href="{% url 'assign_confirm' %}?session_id={{ s.id }}&coach_id={{ coach.id }}&origin={{ request.get_full_path|urlencode }}">
                  M’inscrire
                </a>
              {% endif %}
              {% comment %} {% endwith %} {% endcomment %}
            </div>
            <div>Encadrants inscrits : {{ s.confirmed_cnt }} / Minimum requis : {{ s.min_coaches }}</div>
          </div>
        {% endwith %}
      {% endfor %}
    {% endwith %}
  {% empty %}
    <p>Aucune séance à venir.</p>
  {% endfor %}
  <div class="pagination">
    {% if page_obj.has_previous %}<a href="?page={{ page_obj.previous_page_number }}">← Précédent</a>{% endif %}
    Page {{ page_obj.number }} / {{ paginator.num_pages }}
    {% if page_obj.has_next %}<a href="?page={{ page_obj.next_page_number }}">Suivant →</a>{% endif %}
  </div>
{% endblock content %}
