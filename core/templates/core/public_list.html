{% extends "core/base.html" %}
{% block title %}{{ kind_label }} — Vue publique{% endblock %}
{% block h1 %}{{ kind_label }} — Vue publique{% endblock %}

{% block content %}

<form method="get" class="toolbar">
  <label>Jour:
    <select name="day">
      <option value="">— Tous —</option>
      {% for d in "1,2,3,4,5,6,7".split(",") %}
        {% with di=d|add:""|int %}
          <option value="{{ d }}" {% if selected.day == d %}selected{% endif %}>
            {% if di == 1 %}Lundi{% elif di == 2 %}Mardi{% elif di == 3 %}Mercredi{% elif di == 4 %}Jeudi{% elif di == 5 %}Vendredi{% elif di == 6 %}Samedi{% else %}Dimanche{% endif %}
          </option>
        {% endwith %}
      {% endfor %}
    </select>
  </label>

  <label>Lieu:
    <select name="location">
      <option value="">— Tous —</option>
      {% for loc in locations %}
        <option value="{{ loc }}" {% if selected.location == loc %}selected{% endif %}>{{ loc }}</option>
      {% endfor %}
    </select>
  </label>

  <label>Encadrant:
    <select name="coach">
      <option value="">— Tous —</option>
      {% for m in members %}
        <option value="{{ m.id }}" {% if selected.coach|add:""|stringformat:"s" == m.id|stringformat:"s" %}selected{% endif %}>{{ m.first_name }} {{ m.last_name }}</option>
      {% endfor %}
    </select>
  </label>

  <label>
    <input type="checkbox" name="missing" value="1" {% if selected.missing == "1" %}checked{% endif %}>
    Manque des encadrants
  </label>

  <button class="btn" type="submit">Filtrer</button>
</form>

<div class="sep"></div>

{% if sessions %}
  {% for s in sessions %}
    <div class="card">
      <div class="row">
        <div>
          <div><strong>{{ s.title_auto }}</strong></div>
          <div class="muted">
            {{ s.start_at|date:"l d/m/Y H:i" }} — Semaine {{ s.week_iso }} ({{ s.week_parity }})
            {% if s.assignments.filter(status="confirmed").count < s.min_coaches %}
              <span class="pill need">Besoin: {{ s.assignments.filter(status="confirmed").count }}/{{ s.min_coaches }}</span>
            {% else %}
              <span class="pill success">Couvert: {{ s.assignments.filter(status="confirmed").count }}/{{ s.min_coaches }}</span>
            {% endif %}
          </div>
          <div class="badges" style="margin-top:6px">
            {% for a in s.assignments.all %}
              {% if a.status == "confirmed" %}
                <span class="badge">{{ a.coach.first_name }} {{ a.coach.last_name }}{% if a.role %} · {{ a.get_role_display }}{% endif %}</span>
              {% endif %}
            {% empty %}
              <span class="muted">Aucun encadrant inscrit pour le moment.</span>
            {% endfor %}
          </div>
        </div>
        <div>
          <form method="post" action="{% url 'public_assign' s.id %}">
            {% csrf_token %}
            <select name="coach_id">
              {% for m in members %}
                <option value="{{ m.id }}">{{ m.first_name }} {{ m.last_name }}</option>
              {% endfor %}
            </select>
            <button class="btn" type="submit" onclick="return confirm('Confirmer l’inscription ?')">S’inscrire</button>
          </form>

          <form method="post" action="{% url 'public_withdraw' s.id %}">
            {% csrf_token %}
            <select name="coach_id">
              {% for m in members %}
                <option value="{{ m.id }}">{{ m.first_name }} {{ m.last_name }}</option>
              {% endfor %}
            </select>
            <button class="btn" type="submit" onclick="return confirm('Confirmer la désinscription ?')">Se désinscrire</button>
          </form>
        </div>
      </div>
    </div>
  {% endfor %}
{% else %}
  <p>Aucune séance trouvée avec ces filtres.</p>
{% endif %}

{% endblock %}
