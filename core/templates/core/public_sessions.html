{% extends "core/base.html" %}
{% block content %}
  <h1>{{ page_title }}</h1>
  <style>
/* Filtres */
.filters { margin: 10px 0 16px; }
.filters select, .filters input { margin-right: 8px; }

/* Carte séance */
.session-card {
  border: 1px solid #ccc; border-radius: 8px;
  padding: 12px 14px; margin: 10px 0;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.session-missing { border-color: #d9534f; background-color: #f8d7da; }
.session-header { font-weight: 600; margin: 0 0 8px 0; font-size: 1rem; line-height: 1.3; }

/* Coach chips */
.coach-chip{
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 10px; border:1px solid #ccc; border-radius:14px;
  margin:4px 6px 0 0; font-size:0.95rem;
}
.coach-chip a.remove{ text-decoration:none; font-weight:700; font-size:1.1rem; line-height:1; }

/* Ajout encadrant (mobile-first) */
.add-box{ margin-top:10px; }
.coach-input{
  width:100%; padding:10px; border:1px solid #bbb; border-radius:8px; font-size:1rem;
}

/* Suggestions (liste déroulante sous l’input) */
.suggest{ position:relative; margin-top:6px; display:none; }
.suggest.show{ display:block; }
.suggest ul{
  list-style:none; margin:0; padding:0; border:1px solid #ccc; border-radius:8px; background:#fff;
  max-height:220px; overflow:auto;
}
.suggest li{ padding:10px 12px; cursor:pointer; }
.suggest li:hover{ background:#f2f2f2; }

/* Touch targets plus grands sur petits écrans */
@media (max-width: 480px){
  .session-card{ padding:14px; }
  .session-header{ font-size:1.05rem; }
  .coach-chip{ padding:8px 12px; font-size:1rem; }
  .coach-chip a.remove{ font-size:1.25rem; }
}
  </style>
  <form class="filters" method="get">
    <select name="loc">
      <option value="">Tous lieux</option>
      {% for l in locations %}
        <option value="{{ l.id }}"
                {% if params.loc == l.id|stringformat:"s" %}selected{% endif %}>{{ l.name }}</option>
      {% endfor %}
    </select>
    <select name="dow">
      <option value="">Tous jours</option>
      <option value="2" {% if params.dow == "2" %}selected{% endif %}>Lundi</option>
      <option value="3" {% if params.dow == "3" %}selected{% endif %}>Mardi</option>
      <option value="4" {% if params.dow == "4" %}selected{% endif %}>Mercredi</option>
      <option value="5" {% if params.dow == "5" %}selected{% endif %}>Jeudi</option>
      <option value="6" {% if params.dow == "6" %}selected{% endif %}>Vendredi</option>
      <option value="7" {% if params.dow == "7" %}selected{% endif %}>Samedi</option>
      <option value="1" {% if params.dow == "1" %}selected{% endif %}>Dimanche</option>
    </select>
    <input type="text"
           name="coach"
           placeholder="Coach inscrit…"
           value="{{ params.coach|default_if_none:'' }}" />
    <label>
      <input type="checkbox"
             name="needs"
             value="1"
             {% if params.needs == "1" %}checked{% endif %}>
      Manque encadrants
    </label>
    <button type="submit">Filtrer</button>
  </form>
  {% for yw, sessions in weeks %}
    {% with year=yw.0 week=yw.1 %}
      <h2>Semaine {{ week }} ({{ year }})</h2>
      {% for s in sessions %}
        <div class="session-card {% if s.confirmed_cnt < s.min_coaches %}session-missing{% endif %}">
          <div class="session-header">{{ s.title_auto }}</div>
          <div>
            Encadrants :
            {% for a in s.assignments.all %}
              {% if a.status == "confirmed" %}
                <span class="coach-chip">
                  {{ a.coach }}
                  <a class="remove"
                     title="Retirer"
                     href="{% url 'unassign_confirm' %}?session_id={{ s.id }}&coach_id={{ a.coach.id }}&origin={{ request.path|urlencode }}">×</a>
                </span>
              {% endif %}
            {% empty %}Aucun
            {% endfor %}
          </div>
          <div>Besoin : {{ s.confirmed_cnt }}/{{ s.min_coaches }}</div>
          <div class="add-box" data-session="{{ s.id }}">
            <input type="text" class="coach-input" placeholder="Ajouter un encadrant…">
            <div class="suggest">
              <ul>
                <!-- populated by JS -->
              </ul>
            </div>
          </div>
        </div>
      {% endfor %}
    {% endwith %}
  {% empty %}
    <p>Aucune séance à venir.</p>
  {% endfor %}
  {{ available_coaches|json_script:"coachesData" }}
  {% load static %}
  <script src="{% static 'display_coach.js' %}"></script>
  <div class="pagination">
    {% if page_obj.has_previous %}<a href="?page={{ page_obj.previous_page_number }}">← Précédent</a>{% endif %}
    Page {{ page_obj.number }} / {{ paginator.num_pages }}
    {% if page_obj.has_next %}<a href="?page={{ page_obj.next_page_number }}">Suivant →</a>{% endif %}
  </div>
{% endblock content %}
